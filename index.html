<!DOCTYPE HTML>
<html>

<head>
<meta charset="utf-8" />
<link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="tinybox/style.css" />
<script type="text/javascript" src="https://ajax.microsoft.com/ajax/jQuery/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="tinybox/tinybox.js"></script>
<script type="text/javascript" src="tinybox/packed.js"></script>
<script type="text/javascript">  

emptyInsert = function(item)
{
	if (item.attr("value").match(/^New /g))
   {
		item.attr("value", "");
	}
}

function dispButtonAdd(){
	$("div.wrapadd").remove();
	buttonAdd = $("<div class='wrapadd'><img src='img/addData.png' id='add' class='button add'/></div>");
	$("table.menu").first().prepend(buttonAdd);
	$("img.button#add").unbind('click').click(function(){
	addDataRow();
	$("div.wrapadd").hide();
	
	buttonValid = $("<div class='wrapvalid'><img src='img/validData.png' id='valid' class='button valid'/></div>");
	$("table.menu").first().prepend(buttonValid);
		tcurrent.find("thead").first().find("tr").first().children().each(function(){
		val = $(this).text();
		str = val.toLowerCase();
		str = str.replace(/ /g, '');
		str = str.replace(/id$/g, '');
	});
	$("img.button#valid").click(function(){
		var input = $("input.addInfo").serializeArray();
		keys = Object.keys(input);
		for (var i in keys){
		alert(input[i].name + ': ' + input[i].value);
		}
	});
	
	buttonCancel = $("<div class='wrapcancel'><img src='img/cancelData.png' id='cancel' class='button cancel'/></div>");
	$("table.menu").first().prepend(buttonCancel);
	$("img.button#cancel").click(function(){
		$("table.onglet.current tr.add").toggle();
		$("img.button").remove();
		tableResult(true);
		});	
	});
}

function tableResult(dir)
{
	if(dir)
	{
		dispButtonAdd();
		$("table.menu td:not(.current)").unbind('click').click(function(){
			//$("div.wrapadd").remove();
			$("table.onglet tr.add").remove();
			var current = $(this).attr('targ');
			$(".onglet.current").toggleClass('current').hide();
			$("#" + current).show().toggleClass('current');
			$("table.menu td.current").toggleClass("current");
			$(this).toggleClass("current");
			tableResult(true);
		});
	}
	else
	{
		$("table.menu td:not(.current)").unbind('click');
	}
}

function addDataRow()
{
	//dispButtonAdd();
	current = $("table.menu td.current").attr('targ');
	tcurrent = $("body").find("table.onglet#"+current);
	$("table.menu, table.onglet.current").show();
	if (tcurrent.find("tr.add").length == 0)
	{
		tcurrent.prepend($("<tr class='add'></tr>")); // .append($("<form id='addInfo' name='addInfo' method='post'></form>"))
		tcurrent.find("thead").first().find("tr").first().children().each(function(){
			val = $(this).text();
			str = val.toLowerCase();
			str = str.replace(/ /g, '');
			len = $(this).width()-30;
			if (!str.match(/id$/g))
				$("tr.add").append("<td><input style='width:" + len + "px;' class='addInfo' type='text' id='" + str + "' name='" + str + "' value='New " + val + "...'  onfocus='emptyInsert($(this))'/></td>");
			else
				$("tr.add").append("<td></td>");
		});
		tableResult(false);

	}
	else
	{
		tcurrent.find("tr.add").toggle();
		tableResult(true);
	}
}

	// parse url
	
$(document).ready(function() {  

	var url = window.location.href;
	var qparts = url.split("?");
	if (qparts.length == 0)
	{
		  return "";
	}
	var query = qparts[1];
	
	});
	//alert(query);
	
	function getResult(searchstring)
	{
		$("table.menu, table.onglet.current").show();
		tableResult(true);
		$.ajax({  
		type: "GET",  
		url: "queries.php",  
		//url: "http://dbproject13.azurewebsites.net/queries.php",
		data:{
			action:'globalquery',
			keyword: searchstring,
		},
		dataType: "xml",  
		success: parseXml
		});
		//alert(searchstring);
	}

function loadOnClick()
{
	$("table.onglet tbody tr:not(.add)").click(function(){
	id = $(this).attr('id');
	//alert(id)
	if (id.match(/[a-z]id/)){
		str = id.match(/([a-z]id-)(.{3,8})/);
	}			
	else if (id.match(/ioc/)){
		str = id.match(/(ioccode-)(.{3,8})/);
	}
	
	//alert(str[1] + ': ' + str[2]);
	current = $("table.menu td.current").attr('targ');
	//TINY.box.show({iframe:'details/'+ current +'.html',width:600,height:400,close:false,boxid:'frameless'})
	TINY.box.show({iframe:'details/details.html?' + current + '#' + str[2],width:600,height:400,close:false,boxid:'frameless'})
	});

}
 

function parseXml(xml)
{  

	$(xml).find("athletes>athlete").each(function() { 
		aid = $(this).attr("aid");
		strcountry='';
		strsport='';
		$(this).find("cname").each(function(){
			strcountry += $(this).text() + '<br/>';
		});
		$(this).find("sname").each(function(){
			strsport += $(this).text() + '<br/>';
		});
		$("#athlete").append('<tr id="aid-' + aid + '">' + '<td>' + aid + '</td>' + '<td>' + $(this).find("aname").text() + '</td>'+ '<td>' + strcountry + '</td>' + '<td>' + strsport + '</td>' +' </tr>');  
	});  
	$(xml).find("countries>country").each(function() {   
		ioc = $(this).attr("iocCode");
		$("#country").append('<tr id="ioccode-' + ioc + '">' + '<td>' + ioc + '</td>' + '<td>' + $(this).find("cname").text() + '</td>' +' </tr>');  
	});  
	$(xml).find("sports>sport").each(function() {  
		sid = $(this).attr("sid");	
		$("#sport").append('<tr id="sid-' + sid + '">' + '<td>' + sid + '</td>' + '<td>' + $(this).find("sname").text() + '</td>' +' </tr>');  
	});  
	$(xml).find("disciplines>discipline").each(function() {  
		did = $(this).attr("did");	
		$("#discipline").append('<tr id="did-' + did + '">' + '<td>' + did+ '</td>' + '<td>' + $(this).find("dname").text() + '</td>'+ '<td>' + $(this).find("sname").text() + '</td>' +' </tr>');  
	});
	$(xml).find("games>game").each(function() {
		gid = $(this).attr("gid");
		$("#game").append('<tr id="gid-' + gid + '">' + '<td>' + gid + '</td>' + '<td>' + $(this).find("year").text() + '</td>'+ '<td>' + $(this).find("season").text() + '</td>' + '<td>' + $(this).find("city").text() + '</td>' + '<td>' + $(this).find("cname").text() + '</td>' +' </tr>');  
	});		

	loadOnClick();

}; 


$(document).ready(function() {  	


	$("table#athlete").toggleClass('current');
	//$("input#search").unbind('keypress').keypress(function(e){
	//	if(e.which == 13) {
	//	$("table.onglet tbody tr:not(.add)").empty();
	//	getResult();
	//	}
	
	$("label#magnetizer").unbind('click').click(function(){
		$("table.onglet tbody tr:not(.add)").empty();
		
		var searchstring = $("input.search");
		keys = Object.keys(searchstring);
		//for (var i in keys){
			//alert(searchstring[0].value);
		//}
		getResult(searchstring[0].value); //Ajouter un argument (searchString) Ã  getresult!
	});  
	
	$("table.menu td[targ='athlete']").addClass("current");
	$("table").hide();	
	
	$("p.advancedsearch").click(function(){
	TINY.box.show({iframe:'advancedSearch.html',width:400,height:435,close:false,boxid:'frameless'})
	});
});
</script>

	<title>The Olympics Database</title>

</head>

<body>

<!-- Search field -->
    <form>
	<img src="img/title.png" id="headimg" alt="Header picture"/>
        <input type="text" class ="search" onfocus="if(this.value == 'Search...') { this.value = ''; }" value = "Search..."></input>
        <label for="search" id="magnetizer" onclick="obj=document.getElementById('result').scrollIntoView();">Search</label>
		<p class="advancedsearch">Advanced search</p>

    </form>
<!-- End search field -->

<a id="result"/>

<!-- Onglets-->

<table class="menu"><tr><td targ="athlete">Athlete</td><td targ="country">Country</td>
		<td targ="sport">Sport</td><td targ="discipline">Discipline</td><td targ="game">Game</td></tr></table>
		

<table class="onglet" id="athlete">
   <thead> <tr><th>ID</th> <th>Name</th><th>Country</th> <th>Sport</th></tr>
   </thead>
   <tbody>
   </tbody>
</table>

<table class="onglet" id="country">
   <thead> <tr><th>IOC Code</th> <th>Name</th> </tr>
   </thead>
   <tbody>
   </tbody>
</table>

<table class="onglet" id="sport">
   <thead> <tr><th>ID</th> <th>Name</th> </tr>
   </thead>
   <tbody>
   </tbody>
</table>

<table class="onglet" id="discipline">
   <thead> <tr><th>ID</th> <th>Name</th> <th>Sport</th> </tr>
   </thead>
   <tbody>
   </tbody>
</table>

<table class="onglet" id="game">
   <thead> <tr><th>ID</th> <th>Year</th>  <th>Season</th> <th>City</th> <th>Country</th></tr>
   </thead>
   <tbody>
   </tbody>
</table>


<!-- Get results-->



<!-- PopUp script -->


</body>
</html> 
